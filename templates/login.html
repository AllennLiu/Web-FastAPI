<!DOCTYPE html>
<html>
<head>
    <title>登入 FastAPI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="fastapi icon" href="{{ url_for('static', path='images/fastapi-logo.png') }}" />
    <link rel="stylesheet" id="bootstrap-css" href="{{ url_for('static', path='login/bootstrap.min.css') }}">
    <script type="text/javascript" language="javascript" src="{{ url_for('static', path='login/jquery.min.js') }}"></script>
    <script type="text/javascript" language="javascript" src="{{ url_for('static', path='login/bootstrap.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='login/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/font-awesome.min.css') }}">
    <script src="{{ url_for('static', path='js/font-awesome.min.js') }}"></script>
</head>
<body>
    <div class="container">
    <div class="overlay" id="overlay">
        <div class="sign-in" id="sign-in">
        <h1>歡迎回來！</h1>
        <p>您可以登入來維繫我們的感情。</p>
        <button class="switch-button" id="slide-right-button">登入</button>
        </div>
        <div class="sign-up" id="sign-up">
        <h1>嗨，好久不見！</h1>
        <p>填寫您的個人信息，然後加入我們吧。</p>
        <button class="switch-button" id="slide-left-button">註冊</button>
        </div>
    </div>
    <div class="form">
        <div class="sign-in" id="sign-in-info">
        <h1>登入用戶</h1>
        <div class="social-media-buttons">
            <div class="icon">
            <svg viewBox="0 0 24 24">
                <path fill="#000000" d="M17,2V2H17V6H15C14.31,6 14,6.81 14,7.5V10H14L17,10V14H14V22H10V14H7V10H10V6A4,4 0 0,1 14,2H17Z" />
            </svg>
            </div>
            <div class="icon">
            <svg viewBox="0 0 24 24">
                <path fill="#000000" d="M23,11H21V9H19V11H17V13H19V15H21V13H23M8,11V13.4H12C11.8,14.4 10.8,16.4 8,16.4C5.6,16.4 3.7,14.4 3.7,12C3.7,9.6 5.6,7.6 8,7.6C9.4,7.6 10.3,8.2 10.8,8.7L12.7,6.9C11.5,5.7 9.9,5 8,5C4.1,5 1,8.1 1,12C1,15.9 4.1,19 8,19C12,19 14.7,16.2 14.7,12.2C14.7,11.7 14.7,11.4 14.6,11H8Z" />
            </svg>
            </div>
            <div class="icon">
            <svg viewBox="0 0 24 24">
            <path fill="#000000" d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" />
            </svg>
            </div>
        </div>
        <p class="small">或使用您的郵箱地址:</p>
        <form id="sign-in-form" action="#" method="post" autocomplete="on">
            <input type="text" name="username" id="username" placeholder="郵箱/工號"/>
            <input type="password" name="password" id="password" placeholder="開機密碼"/>
            <p class="forgot-password">忘記密碼嗎？</p>
            <button id="login" class="control-button in" type="button" onclick="loginEvent()"><i id="login-icon" class="fa fa-sign-in"></i> 登入</button>
        </form>
        </div>
        <div class="sign-up" id="sign-up-info">
        <h1>建立用戶</h1>
        <div class="social-media-buttons">
            <div class="icon">
            <svg viewBox="0 0 24 24">
                <path fill="#000000" d="M17,2V2H17V6H15C14.31,6 14,6.81 14,7.5V10H14L17,10V14H14V22H10V14H7V10H10V6A4,4 0 0,1 14,2H17Z" />
            </svg>
            </div>
            <div class="icon">
            <svg viewBox="0 0 24 24">
                <path fill="#000000" d="M23,11H21V9H19V11H17V13H19V15H21V13H23M8,11V13.4H12C11.8,14.4 10.8,16.4 8,16.4C5.6,16.4 3.7,14.4 3.7,12C3.7,9.6 5.6,7.6 8,7.6C9.4,7.6 10.3,8.2 10.8,8.7L12.7,6.9C11.5,5.7 9.9,5 8,5C4.1,5 1,8.1 1,12C1,15.9 4.1,19 8,19C12,19 14.7,16.2 14.7,12.2C14.7,11.7 14.7,11.4 14.6,11H8Z" />
            </svg>
            </div>
            <div class="icon">
            <svg viewBox="0 0 24 24">
            <path fill="#000000" d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" />
            </svg>
            </div>
        </div>
        <p class="small">或使用您的郵箱地址註冊:</p>
        <form id="sign-up-form" action="#" method="post" autocomplete="off">
            <input type="text" name="sname" id="sname" placeholder="名稱"/>
            <input type="email" name="sname" id="suser" placeholder="郵箱"/>
            <input type="password" name="sname" id="spass" placeholder="密碼"/>
            <button id="signup" class="control-button up" type="button" onclick="register()"><i id="sign-up-icon" class="fa fa-pencil-square-o"></i> 註冊</button>
        </form>
        </div>
    </div>
    </div>

    <div id="info" class="alert alert-info alert-dismissible message-box-custom" role="alert">
        <button type="button" class="close" onclick="fadeOutById(this.parentElement.id, 600);"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <strong><i class="fa fa-info-circle"></i> Notify!</strong> <font id="infoLabel"></font>
    </div>

    <div id="success" class="alert alert-success alert-dismissible message-box-custom" role="alert">
        <button type="button" class="close" onclick="fadeOutById(this.parentElement.id, 600);"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <strong><i class="fa fa-check-circle"></i> Successfully!</strong> <font id="successLabel"></font>
    </div>

    <div id="warning" class="alert alert-warning alert-dismissible message-box-custom" role="alert">
        <button type="button" class="close" onclick="fadeOutById(this.parentElement.id, 600);"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <strong><i class="fa fa-exclamation-triangle"></i> Warning!</strong> <font id="warningLabel"></font>
    </div>

    <div id="error" class="alert alert-danger alert-dismissible message-box-custom" role="alert">
        <button type="button" class="close" onclick="fadeOutById(this.parentElement.id, 600);"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <strong><i class="fa fa-times-circle"></i> Oops!</strong> <font id="errorLabel"></font>
    </div>

</body>

{# block javascript #}
<script type="text/javascript">
  function fadeOutById(id, delay) {
    var elem = document.getElementById(id);
    if (elem == null) {
      return;
    }
    if (elem.style.display == "none") {
      return;
    }
    $(`#${id}`).fadeOut(delay, function(){
      elem.style.display = "none";
    });
  }
  {% if redirect != 'none' %}
    var warning = document.getElementById("warning");
    var wlabel = document.getElementById("warningLabel");
    warning.style.display = 'block';
    wlabel.innerHTML = "非常抱歉，訪問 FastAPI 前請先登入。";
    setTimeout(function() {
      fadeOutById(warning.id, 600);
    }, 6000);
  {% endif %}
</script>
{# endblock #}

<script type="text/javascript" src="{{ url_for('static', path='login/login.js') }}"></script>
<script type="text/javascript">
function loginEvent() {
    var login = document.getElementById("login");
    classSwitch("login-icon", "fa fa-spinner fa-spin");

    var user = document.getElementById("username");
    var pass = document.getElementById("password");
    var username = user.value;
    var password = pass.value;

    if ( ! /^(.{8,})/.test(password) ) {
      document.getElementById("password").focus();
      elabel.innerHTML = "請符合指定格的密碼，長度必須為 8 個字元以上";
      error.style.display = "block";
      classSwitch("login-icon", "fa fa-sign-in");
      setTimeout(function() {
        error.style.display = "none";
      }, 6000);
    } else if ( ! /^((ie|IE)[sS|cC]\w{6})|\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(username) ) {
      user.focus();
      elabel.innerHTML = "請符合指定格式的帳號，必須為英業達員工編號或註冊郵箱";
      error.style.display = "block";
      classSwitch("login-icon", "fa fa-sign-in");
      setTimeout(function() {
        error.style.display = "none";
      }, 6000);
    } else {
      var encryption = window.btoa(window.btoa(password));
      login.style.cursor = "not-allowed";
      login.setAttribute("onclick", "");
      $.ajax({
        type: "POST",
        url: "../auth/token",
        data: {
          username: username,
          password: encryption
        },
        success: function(res){
          var redir = "{{ redirect }}";
          var baseurl = "{{ request.base_url }}";
          var redirect_url;
          var base_url = baseurl.replace(/\/$/g, '');
          if ( /^(none|\/)$/g.test(redir) ) {
            redirect_url = base_url;
          } else {
            redirect_url = `${base_url}${redir}`;
          }
          slabel.innerHTML = "使用者用戶與密碼正確，即將登入系統..";
          success.style.display = "block";
          setTimeout(function() {
            success.style.display = "none";
            setTimeout(function() {
              restoreBtn("login", "login-icon", "fa fa-sign-in", "loginEvent()");
              document.location = redirect_url;
            }, 1000);
          }, 2000);

        },
        error: function(jqXHR, textStatus, errorThrown){
          const statusCode = jqXHR.status;
          if (statusCode == 401){
            elabel.innerHTML = "無效的用戶名稱或開機密碼";
            user.focus();
            setTimeout(function() {
              pass.focus();
            }, 800);
          } else {
            console.log(jqXHR);
            console.log(statusCode);
            elabel.innerHTML = "訪問服務器失敗，請檢查網路是否已連接";
          }
          error.style.display = "block";
          setTimeout(function() {
            error.style.display = "none";
            restoreBtn("login", "login-icon", "fa fa-sign-in", "loginEvent()");
          }, 6000);
        },
      });
    }
}
</script>
</html>